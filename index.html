<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analítica de Competencias — Maestría en Gerencia de Proyectos</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Chart.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    #map { height: 420px; }
    .chart-wrap { height: 320px; }
    .chart-wrap > canvas { width:100% !important; height:100% !important; display:block; }
    .tab-hidden { display: none; }
  </style>
</head>
<body class="min-h-screen bg-slate-100 text-slate-900">

  <!-- Header -->
  <header class="bg-white/80 backdrop-blur border-b sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <div>
        <h1 class="text-xl md:text-2xl font-semibold">Analítica de Competencias — Maestría en Gerencia de Proyectos</h1>
        <p class="text-xs text-slate-500 mt-1">Form → Sheet → Apps Script (JSON) → Dashboard</p>
      </div>

      <!-- NAV: ENLACES reales + id -->
      <nav class="flex gap-2" role="tablist" aria-label="Secciones">
        <a id="tab-intro"   href="#intro"   data-tab="intro"
           class="tab-link px-3 py-2 text-sm rounded-full border bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-900"
           aria-selected="true">¿Para qué sirve?</a>
        <a id="tab-form"    href="#form"    data-tab="form"
           class="tab-link px-3 py-2 text-sm rounded-full border bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-900">Formulario</a>
        <a id="tab-metrics" href="#metrics" data-tab="metrics"
           class="tab-link px-3 py-2 text-sm rounded-full border bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-900">Métricas</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 space-y-4">

    <!-- Intro -->
    <section id="panel-intro" role="tabpanel" aria-labelledby="tab-intro"
             class="bg-white rounded-2xl border shadow-sm p-6 space-y-4">
      <div class="rounded-2xl p-6 bg-gradient-to-r from-indigo-50 to-sky-50 border">
        <h2 class="text-lg font-semibold mb-2">¿Para qué sirve esta página?</h2>
        <p class="leading-relaxed">
          Este tablero muestra, casi en tiempo real, las respuestas del formulario
          <em>“Competencias de Analítica de Datos”</em> para estudiantes de la Maestría en Gerencia de Proyectos.
          Aprendemos <strong>qué herramientas usan</strong>, <strong>cuántas horas dedican</strong> y
          <strong>dónde están</strong> (por dirección o ciudad) para orientar mejor las clases.
        </p>
        <p class="mt-3 text-slate-700 italic">“Lo que no se mide, no se puede mejorar.”</p>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <div class="p-4 rounded-xl border bg-slate-50">
          <h3 class="font-semibold mb-2">Lo que verás</h3>
          <ul class="list-disc pl-6 space-y-1 text-sm">
            <li>Métricas: total de respuestas, % con consentimiento, horas/semana promedio.</li>
            <li>Gráficos: barras por herramientas y donut por programa.</li>
            <li>Mapa: marcadores por dirección (Nominatim) o por ciudad (Open-Meteo) si la dirección viene vacía.</li>
            <li>Tabla: últimas 10 respuestas + exportar CSV.</li>
          </ul>
        </div>
        <div class="p-4 rounded-xl border bg-slate-50">
          <h3 class="font-semibold mb-2">¿Para qué se usa?</h3>
          <ul class="list-disc pl-6 space-y-1 text-sm">
            <li>Diagnóstico de competencias y brechas.</li>
            <li>Plan de formación focalizado.</li>
            <li>Pipeline libre: Form → Sheet → API → Visualización.</li>
            <li>Conversación sobre calidad de datos, sesgos y privacidad.</li>
          </ul>
        </div>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <div class="p-4 rounded-xl border">
          <h3 class="font-semibold mb-2">Privacidad y consentimiento</h3>
          <p class="text-sm text-slate-700">
            Se contabiliza el campo <em>consentimiento</em>. Geocodificación con
            <strong>Nominatim (OSM)</strong> y <strong>Open-Meteo Geocoding</strong>.
            No guardamos coordenadas en servidores; solo en caché local de tu navegador.
          </p>
        </div>
        <div class="p-4 rounded-xl border">
          <h3 class="font-semibold mb-2">Limitaciones técnicas</h3>
          <ul class="list-disc pl-6 space-y-1 text-sm">
            <li>Nominatim limita frecuencia → caché y <em>backoff</em> automático.</li>
            <li>Si no hay dirección, se intenta ciudad; si tampoco hay ciudad, esa respuesta no se ubica.</li>
            <li>Primera geocodificación puede tardar; luego es instantánea por caché.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Formulario -->
    <section id="panel-form" role="tabpanel" aria-labelledby="tab-form"
             class="bg-white rounded-2xl border shadow-sm p-6 tab-hidden">
      <h2 class="text-lg font-semibold mb-3">Responder formulario</h2>
      <p class="text-sm text-slate-600 mb-3">Completa el formulario; luego ve a <em>Métricas</em> y pulsa <strong>Actualizar datos</strong>.</p>
      <div class="rounded-2xl overflow-hidden border">
        <iframe
          id="form-iframe"
          title="Formulario de Competencias"
          src="https://docs.google.com/forms/d/e/1FAIpQLScS4P82BUgl-OSwIRkPIcuobN-jmvhcPkHuhy2acmKeF5na2A/viewform?embedded=true"
          width="100%" height="900" frameborder="0" marginheight="0" marginwidth="0"
          referrerpolicy="no-referrer-when-downgrade" loading="lazy">Cargando…</iframe>
      </div>
      <p id="form-blocked"
         class="hidden mt-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2">
        El formulario no pudo cargarse aquí (bloqueado por el navegador).
        <a class="underline" href="https://docs.google.com/forms/d/e/1FAIpQLScS4P82BUgl-OSwIRkPIcuobN-jmvhcPkHuhy2acmKeF5na2A/viewform" target="_blank" rel="noopener">Ábrelo en una pestaña nueva</a>.
      </p>
    </section>

    <!-- Métricas -->
    <section id="panel-metrics" role="tabpanel" aria-labelledby="tab-metrics"
             class="tab-hidden">
      <div class="bg-white rounded-2xl border shadow-sm p-6 space-y-4">

        <div id="statusBar" class="hidden rounded-xl border px-4 py-3 text-sm"></div>

        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex gap-2">
            <select id="programFilter" class="border rounded-lg px-2 py-1 text-sm">
              <option value="">Todos los programas</option>
            </select>
            <select id="toolFilter" class="border rounded-lg px-2 py-1 text-sm">
              <option value="">Todas las herramientas</option>
              <option>Excel</option><option>Power BI</option><option>Python</option>
              <option>R</option><option>SQL</option><option>Otro</option>
            </select>
          </div>
          <button id="refreshBtn" class="rounded-full bg-slate-900 text-white px-4 py-2 text-sm hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-900">
            Actualizar datos
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-white rounded-2xl shadow-sm p-4 border">
            <div class="text-sm text-slate-500">Total respuestas</div>
            <div id="metricTotal" class="text-3xl font-semibold mt-1">—</div>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 border">
            <div class="text-sm text-slate-500">% con consentimiento</div>
            <div id="metricConsent" class="text-3xl font-semibold mt-1">—</div>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 border">
            <div class="text-sm text-slate-500">Horas/semana promedio</div>
            <div id="metricHours" class="text-3xl font-semibold mt-1">—</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="bg-white rounded-2xl shadow-sm p-4 border">
            <h3 class="text-base font-semibold mb-2">Herramientas (conteo)</h3>
            <div class="chart-wrap"><canvas id="barTools"></canvas></div>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 border">
            <h3 class="text-base font-semibold mb-2">Programas (distribución)</h3>
            <div class="chart-wrap"><canvas id="donutPrograms"></canvas></div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-4 border">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-base font-semibold">Mapa de respuestas</h3>
            <div class="text-xs text-slate-500">OSM • Nominatim • Open-Meteo (ciudad)</div>
          </div>
          <div id="map"></div>
          <p class="text-xs text-slate-500 mt-2">Caché local de geocodificación; backoff si Nominatim responde 429.</p>
          <div id="nominatimNotice" class="hidden mt-2 text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2 text-sm">
            Nominatim limitó temporalmente las solicitudes (429). Reintentando…
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-4 border">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-base font-semibold">Últimas 10 respuestas</h3>
            <button id="exportCsvBtn" class="rounded-full border px-3 py-1.5 text-sm hover:bg-slate-50">Exportar CSV</button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="text-left text-slate-600">
                <tr>
                  <th class="py-2 pr-3">Fecha</th>
                  <th class="py-2 pr-3">Programa</th>
                  <th class="py-2 pr-3">Herramientas</th>
                  <th class="py-2 pr-3">Horas/sem</th>
                  <th class="py-2 pr-3">Ciudad</th>
                  <th class="py-2 pr-3">Dirección</th>
                  <th class="py-2 pr-3">Consent.</th>
                </tr>
              </thead>
              <tbody id="tableBody" class="divide-y"></tbody>
            </table>
          </div>
        </div>

      </div>
    </section>
  </main>

  <footer class="max-w-7xl mx-auto p-4 text-xs text-slate-500">
    <p>SPA — Tailwind · Chart.js · Leaflet/OSM · Nominatim · Open-Meteo Geocoding</p>
  </footer>

  <script defer>
    /* ===================== Config ===================== */
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbzEJcd_3vhjC-7zjKqI0T7pW50fvWMN3EgoE1frMZmcDjj7tZG5n_eAQb6TkHlnEtno/exec";
    const NOMINATIM_URL = "https://nominatim.openstreetmap.org/search?format=json&q="; // direcciones
    const OPEN_METEO_URL = "https://geocoding-api.open-meteo.com/v1/search?count=1&language=es&format=json&name="; // ciudades

    const TOOL_KEYS = ["Excel","Power BI","Python","R","SQL","Otro"];
    const GEO_CACHE_KEY = "geocodeCacheV2";
    const delay = ms => new Promise(r => setTimeout(r, ms));

    /* ===================== Tabs ===================== */
    const tabs = {
      intro: document.getElementById("panel-intro"),
      form: document.getElementById("panel-form"),
      metrics: document.getElementById("panel-metrics"),
    };
    const tabButtons = document.querySelectorAll(".tab-link");
    const $formIframe = document.getElementById("form-iframe");
    const $formNotice = document.getElementById("form-blocked");
    let metricsInitialized = false;

    function setActiveTab(name) {
      Object.entries(tabs).forEach(([k, el]) => el.classList.toggle("tab-hidden", k !== name));
      tabButtons.forEach(btn => {
        const active = btn.dataset.tab === name;
        btn.setAttribute("aria-selected", active ? "true" : "false");
        btn.classList.toggle("bg-slate-900", active);
        btn.classList.toggle("text-white", active);
        btn.classList.toggle("border-slate-900", active);
        btn.classList.toggle("bg-white", !active);
        btn.classList.toggle("text-slate-900", !active);
      });

      if (name === "form") {
        setTimeout(() => { try { if (!$formIframe.contentDocument) $formNotice.classList.remove("hidden"); } catch {} }, 2000);
      }
      if (name === "metrics" && !metricsInitialized) {
        metricsInitialized = true;
        refreshAll().then(() => { setTimeout(() => { if (map) map.invalidateSize(); }, 50); });
      } else if (name === "metrics" && map) {
        setTimeout(() => map.invalidateSize(), 50);
      }
    }
    function bootFromHash() {
      const h = (location.hash || "#intro").slice(1);
      setActiveTab(["intro","form","metrics"].includes(h) ? h : "intro");
    }
    // Navegación robusta: si el hash no cambia, activamos igual.
    tabButtons.forEach(a => {
      a.addEventListener("click", (e) => {
        e.preventDefault();
        const tab = a.dataset.tab;
        if (location.hash !== `#${tab}`) {
          location.hash = `#${tab}`; // disparará bootFromHash por 'hashchange'
        } else {
          setActiveTab(tab);         // ya estábamos en ese hash
        }
      });
    });
    window.addEventListener("hashchange", bootFromHash);

    /* ===================== Utilidades ===================== */
    const $status = document.getElementById("statusBar");
    const $nominatimNotice = document.getElementById("nominatimNotice");
    const $tableBody = document.getElementById("tableBody");
    const $metricTotal = document.getElementById("metricTotal");
    const $metricConsent = document.getElementById("metricConsent");
    const $metricHours = document.getElementById("metricHours");
    const $programFilter = document.getElementById("programFilter");
    const $toolFilter = document.getElementById("toolFilter");
    const $refreshBtn = document.getElementById("refreshBtn");
    const $exportCsvBtn = document.getElementById("exportCsvBtn");

    function showStatus(msg, type="info") {
      $status.classList.remove("hidden");
      $status.className = "rounded-xl px-4 py-3 text-sm " +
        (type==="error" ? "bg-red-50 text-red-700 border border-red-200" :
         type==="warn"  ? "bg-amber-50 text-amber-700 border border-amber-200" :
                          "bg-sky-50 text-sky-700 border border-sky-200");
      $status.textContent = msg;
    }
    function hideStatus(){ $status.classList.add("hidden"); }
    function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }
    function parseTools(v){ if(!v) return []; return Array.isArray(v)? v.map(x=>String(x).trim()): String(v).split(",").map(s=>s.trim()).filter(Boolean); }
    function loadGeoCache(){ try{ return JSON.parse(localStorage.getItem(GEO_CACHE_KEY)||"{}"); }catch{ return {}; } }
    function saveGeoCache(c){ try{ localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(c)); }catch{} }

    // Normalización flexible
    const FIELD_ALIASES = {
      timestamp:      ["timestamp","marca temporal","marca_temporal","fecha","marca de tiempo"],
      programa:       ["programa","programa-carrera","programa_carrera","carrera","programa - carrera","programa/carrera"],
      herramientas:   ["herramientas","tool","tools"],
      horas_semana:   ["horas_semana","horas","horas semana","hrs","hrs_semana"],
      ciudad:         ["ciudad","city","municipio","localidad"],
      direccion:      ["direccion","dirección","address","dir","direccion residencia"],
      consentimiento: ["consentimiento","consent","autorización","autorizacion","tratamiento de datos","autorizo"],
      email:          ["email","correo","correo electrónico","correo electronico"]
    };
    function isConsentYes(val){
      if (val == null) return false;
      const s = String(val).trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      return ["si","sí","si.","yes","true","1","acepto","de acuerdo","si, acepto","autorizo"].includes(s);
    }
    function parseHours(v){
      if (v == null) return 0;
      const s = String(v).replace(/\s+/g,"").replace(",",".");
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }
    function bestKey(obj, target){
      const keyMap = Object.fromEntries(Object.keys(obj).map(k=>[k.toLowerCase().trim(), k]));
      for (const variant of (FIELD_ALIASES[target]||[])){
        const k = keyMap[variant.toLowerCase()];
        if (k) return k;
      }
      const wanted = target.toLowerCase();
      for (const k of Object.keys(obj)){
        const kl = k.toLowerCase();
        if (kl.includes(wanted)) return k;
        if (wanted==="horas_semana" && (kl.includes("hora")||kl.includes("hrs"))) return k;
        if (wanted==="consentimiento" && kl.includes("consent")) return k;
      }
      return null;
    }
    function canonicalizeRow(row) {
      const out = {};
      const kTs   = bestKey(row,"timestamp");
      const kProg = bestKey(row,"programa");
      const kTool = bestKey(row,"herramientas");
      const kHs   = bestKey(row,"horas_semana");
      const kCity = bestKey(row,"ciudad");
      const kAddr = bestKey(row,"direccion");
      const kCons = bestKey(row,"consentimiento");
      const kMail = bestKey(row,"email");

      out.timestamp      = kTs   ? row[kTs]   : "";
      out.programa       = kProg ? row[kProg] : "";
      out.herramientas   = kTool ? row[kTool] : "";
      out.horas_semana   = parseHours(kHs ? row[kHs] : 0);
      out.ciudad         = kCity ? row[kCity] : "";
      out.direccion      = kAddr ? row[kAddr] : "";
      out.consentimiento = kCons ? row[kCons] : "";
      out.email          = kMail ? row[kMail] : "";

      if (Array.isArray(out.herramientas)) out.herramientas = out.herramientas.join(", ");
      return out;
    }
    function toObjectsFlexible(payload){
      if (payload?.rows && Array.isArray(payload.rows) && typeof payload.rows[0] === "object") return payload.rows;
      if (payload?.data && Array.isArray(payload.data) && typeof payload.data[0] === "object") return payload.data;
      if (Array.isArray(payload) && payload.length && typeof payload[0] === "object" && !Array.isArray(payload[0])) return payload;
      if (payload?.headers && Array.isArray(payload.headers) && payload?.rows && Array.isArray(payload.rows) && Array.isArray(payload.rows[0])) {
        const headers = payload.headers;
        return payload.rows.map(arr => Object.fromEntries(arr.map((v,i)=>[headers[i]??`col${i+1}`, v])));
      }
      const values = payload?.values || (Array.isArray(payload) && Array.isArray(payload[0]) ? payload : null);
      if (values && Array.isArray(values) && values.length >= 2) {
        const headers = values[0];
        const rows = values.slice(1);
        return rows.map(arr => Object.fromEntries(arr.map((v,i)=>[headers[i]??`col${i+1}`, v])));
      }
      if (Array.isArray(payload?.rows) && Array.isArray(payload.rows[0])) {
        return payload.rows.map(arr => Object.fromEntries(arr.map((v,i)=>[`col${i+1}`, v])));
      }
      return [];
    }

    /* ===================== Datos & render ===================== */
    let rawData = [], filteredData = [], charts = { bar:null, donut:null }, map, markersLayer;

    async function fetchData(){
      showStatus("Cargando datos…");
      try{
        const res = await fetch(SHEET_API_URL, { headers:{ "Accept":"application/json" } });
        if(!res.ok) throw new Error("No se pudo obtener el JSON");
        const payload = await res.json();
        const objects = toObjectsFlexible(payload);
        rawData = objects.map(canonicalizeRow);
        hideStatus();
      }catch(e){
        console.error(e);
        showStatus("Error cargando datos. Verifica el Web App de Apps Script.", "error");
      }
    }

    function applyFilters(){
      const prog = $programFilter.value.toLowerCase();
      const tool = $toolFilter.value.toLowerCase();
      filteredData = rawData.filter(r=>{
        const progOk = !prog || String(r.programa||"").trim().toLowerCase() === prog;
        const toolsArr = (String(r.herramientas||"").split(",").map(s=>s.trim().toLowerCase()).filter(Boolean));
        const toolOk = !tool || toolsArr.includes(tool);
        return progOk && toolOk;
      });
    }
    function computeMetrics(rows){
      const total = rows.length;
      const consentYes = rows.filter(r => isConsentYes(r.consentimiento)).length;
      const hours = rows.map(r => parseHours(r.horas_semana));
      const avg = hours.length ? hours.reduce((a,b)=>a+b,0)/hours.length : 0;
      $metricTotal.textContent = total;
      $metricConsent.textContent = total? `${((consentYes/total)*100).toFixed(0)}%` : "0%";
      $metricHours.textContent = avg.toFixed(1);
    }

    function buildCharts(rows){
      if (charts.bar){ charts.bar.destroy(); charts.bar=null; }
      if (charts.donut){ charts.donut.destroy(); charts.donut=null; }

      const toolCounts = Object.fromEntries(TOOL_KEYS.map(k=>[k,0]));
      rows.forEach(r => (String(r.herramientas||"").split(",").map(s=>s.trim()).filter(Boolean)).forEach(t=>{
        const key = TOOL_KEYS.find(k => k.toLowerCase()===t.toLowerCase()) || "Otro";
        toolCounts[key] = (toolCounts[key]||0)+1;
      }));
      charts.bar = new Chart(document.getElementById("barTools"), {
        type:"bar",
        data:{ labels:Object.keys(toolCounts), datasets:[{ label:"Conteo", data:Object.values(toolCounts) }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });

      const progCounts = {};
      rows.forEach(r => { const p = String(r.programa||"Sin programa").trim(); progCounts[p]=(progCounts[p]||0)+1; });
      charts.donut = new Chart(document.getElementById("donutPrograms"), {
        type:"doughnut",
        data:{ labels:Object.keys(progCounts), datasets:[{ data:Object.values(progCounts) }] },
        options:{ responsive:true, maintainAspectRatio:false }
      });

      const unique = Object.keys(progCounts).sort((a,b)=>a.localeCompare(b));
      const current = $programFilter.value;
      $programFilter.innerHTML = `<option value="">Todos los programas</option>` + unique.map(p=>`<option${p===current?' selected':''}>${p}</option>`).join("");
    }

    function renderTable(rows){
      const last10 = [...rows].slice(-10).reverse();
      $tableBody.innerHTML = last10.map(r=>{
        const tools = String(r.herramientas||"");
        return `<tr class="hover:bg-slate-50">
          <td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(r.timestamp||"")}</td>
          <td class="py-2 pr-3">${escapeHtml(r.programa||"")}</td>
          <td class="py-2 pr-3">${escapeHtml(tools)}</td>
          <td class="py-2 pr-3">${parseHours(r.horas_semana)}</td>
          <td class="py-2 pr-3">${escapeHtml(r.ciudad||"")}</td>
          <td class="py-2 pr-3">${escapeHtml(r.direccion||"")}</td>
          <td class="py-2 pr-3">${escapeHtml(r.consentimiento||"")}</td>
        </tr>`;
      }).join("");
    }

    /* ===================== Mapa ===================== */
    function initMap(){
      if (!map){
        map = L.map('map', { scrollWheelZoom:true }).setView([4.65,-74.1], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);
      }
      if (markersLayer) markersLayer.clearLayers(); else markersLayer = L.layerGroup().addTo(map);
    }
    async function geocodeAddress(address, cache) {
      const key = `addr:${address.toLowerCase()}`;
      if (cache[key]) return cache[key];
      await delay(1100);
      const res = await fetch(`${NOMINATIM_URL}${encodeURIComponent(address)}`, { headers:{ "Accept":"application/json","Accept-Language":"es" } });
      if (res.status === 429) { 
        $nominatimNotice.classList.remove("hidden");
        await delay(2000);
        return geocodeAddress(address, cache);
      }
      $nominatimNotice.classList.add("hidden");
      const j = await res.json();
      if (Array.isArray(j) && j.length){
        const loc = { lat:Number(j[0].lat), lon:Number(j[0].lon), source:"nominatim" };
        cache[key] = loc; saveGeoCache(cache);
        return loc;
      }
      return null;
    }
    async function geocodeCity(city, cache) {
      const key = `city:${city.toLowerCase()}`;
      if (cache[key]) return cache[key];
      const res = await fetch(`${OPEN_METEO_URL}${encodeURIComponent(city)}`, { headers:{ "Accept":"application/json" } });
      const j = await res.json();
      if (j && j.results && j.results.length){
        const c = j.results[0];
        const loc = { lat:Number(c.latitude), lon:Number(c.longitude), source:"open-meteo" };
        cache[key] = loc; saveGeoCache(cache);
        return loc;
      }
      return null;
    }
    async function updateMap(rows){
      initMap();
      const cache = loadGeoCache();
      const coordsList = [];
      for (const r of rows){
        const addr = String(r.direccion||"").trim();
        const city = String(r.ciudad||"").trim();
        let loc = null;
        if (addr) loc = await geocodeAddress(addr, cache);
        if (!loc && city) loc = await geocodeCity(city, cache);
        if (loc){ coordsList.push({ ...loc, row:r }); }
      }
      coordsList.forEach(({lat,lon,row,source})=>{
        const tools = String(row.herramientas||"");
        L.marker([lat,lon]).addTo(markersLayer).bindPopup(
          `<div class="text-sm">
            <div><strong>Programa:</strong> ${escapeHtml(row.programa||"")}</div>
            <div><strong>Herramientas:</strong> ${escapeHtml(tools)}</div>
            <div><strong>Horas/sem:</strong> ${parseHours(row.horas_semana)}</div>
            <div class="text-xs text-slate-500 mt-1">Ubicación por: ${source==="open-meteo"?"ciudad (Open-Meteo)":"dirección (Nominatim)"}</div>
          </div>`
        );
      });
      if (coordsList.length){
        const b = L.latLngBounds(coordsList.map(v=>[v.lat,v.lon]));
        map.fitBounds(b.pad(0.25));
      }
    }

    /* ===================== Export & eventos ===================== */
    function exportCsv(rows){
      const headers=["timestamp","programa","herramientas","horas_semana","ciudad","direccion","consentimiento","email"];
      const csv=[ headers.join(","), ...rows.map(r=>headers.map(h=>{
        const v=r[h]??""; const s=Array.isArray(v)?v.join("; "):String(v);
        return (s.includes(",")||s.includes('"')||s.includes("\n"))?`"${s.replaceAll('"','""')}"`:s;
      }).join(",")) ].join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8"}); const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download=`respuestas_analitica_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    async function refreshAll(){
      $refreshBtn.disabled = true; $refreshBtn.classList.add("opacity-60","cursor-not-allowed");
      await fetchData(); applyFilters(); computeMetrics(filteredData); buildCharts(filteredData); renderTable(filteredData); await updateMap(filteredData);
      $refreshBtn.disabled = false; $refreshBtn.classList.remove("opacity-60","cursor-not-allowed");
    }
    function wireEvents(){
      $refreshBtn?.addEventListener("click", refreshAll);
      $programFilter?.addEventListener("change", ()=>{ applyFilters(); computeMetrics(filteredData); buildCharts(filteredData); renderTable(filteredData); updateMap(filteredData); });
      $toolFilter?.addEventListener("change",   ()=>{ applyFilters(); computeMetrics(filteredData); buildCharts(filteredData); renderTable(filteredData); updateMap(filteredData); });
      $exportCsvBtn?.addEventListener("click", ()=>exportCsv(filteredData));
      window.addEventListener("resize", ()=>{ if (map) map.invalidateSize(); });
    }

    document.addEventListener("DOMContentLoaded", () => {
      wireEvents();
      bootFromHash(); // por defecto #intro (cámbialo a "#form" si prefieres abrir en formulario)
    });
  </script>
</body>
</html>
